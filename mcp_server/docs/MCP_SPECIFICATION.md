# Agent Memory MCP API Specification (v1.0.0)

This document defines the formal API contract for the Agent Memory MCP Server. All clients MUST adhere to these schemas to ensure compatibility.

## Protocol Information
- **Protocol**: [Model Context Protocol (MCP)](https://modelcontextprotocol.io/)
- **Versioning Strategy**: Semantic Versioning for API contracts.
- **API Version**: `1.0.0`

## Tools

### 1. `record_decision`
Records a strategic decision into the semantic memory.

**Parameters (JSON Schema):**
```json
{
  "type": "object",
  "properties": {
    "title": { "type": "string", "minLength": 1, "description": "Short title of the decision" },
    "target": { "type": "string", "minLength": 1, "description": "The object or area this decision applies to" },
    "rationale": { "type": "string", "minLength": 10, "description": "Detailed explanation" },
    "consequences": { "type": "array", "items": { "type": "string" }, "default": [] }
  },
  "required": ["title", "target", "rationale"]
}
```

**Response:** `DecisionResponse`

---

### 2. `supersede_decision`
Replaces one or more existing decisions with a new one.

**Parameters (JSON Schema):**
```json
{
  "type": "object",
  "properties": {
    "title": { "type": "string", "minLength": 1 },
    "target": { "type": "string", "minLength": 1 },
    "rationale": { "type": "string", "minLength": 15 },
    "old_decision_ids": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
    "consequences": { "type": "array", "items": { "type": "string" }, "default": [] }
  },
  "required": ["title", "target", "rationale", "old_decision_ids"]
}
```

**Response:** `DecisionResponse`

---

### 3. `search_decisions`
Performs a hybrid semantic search over the memory.

**Parameters (JSON Schema):**
```json
{
  "type": "object",
  "properties": {
    "query": { "type": "string", "minLength": 1 },
    "limit": { "type": "integer", "minimum": 1, "maximum": 20, "default": 5 },
    "mode": { "type": "string", "enum": ["strict", "balanced", "audit"], "default": "balanced" }
  },
  "required": ["query"]
}
```

**Response:** `SearchResponse`

---

### 4. `accept_proposal`
Promotes a draft proposal (generated by reflection) to an active decision. **Requires ADMIN role.**

**Parameters (JSON Schema):**
```json
{
  "type": "object",
  "properties": {
    "proposal_id": { "type": "string", "description": "The filename of the proposal" }
  },
  "required": ["proposal_id"]
}
```

**Response:** `BaseResponse`

---

## Data Models (Responses)

### `BaseResponse`
```json
{
  "type": "object",
  "properties": {
    "status": { "type": "string", "enum": ["success", "error"] },
    "message": { "type": "string", "nullable": true }
  },
  "required": ["status"]
}
```

### `SearchResponse`
Inherits from `BaseResponse`.
```json
{
  "type": "object",
  "properties": {
    "results": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "score": { "type": "number" },
          "status": { "type": "string" },
          "preview": { "type": "string" },
          "kind": { "type": "string" }
        }
      }
    }
  }
}
```

## Search & Ranking Policy

The Agent Memory system uses a **Graph-First Hybrid Search** approach. Vector similarity is used for candidate selection, while the Semantic Graph determines final ranking and visibility.

### Guarantees
1.  **Strict Mode Isolation**: In `strict` mode, non-active decisions are NEVER returned, regardless of their vector similarity.
2.  **State-Aware Ranking**: Active decisions are boosted (+1.0 to score), ensuring they appear above superseded or draft versions of the same or similar knowledge.
3.  **Automatic Deduplication**: If multiple versions of the same `target` (e.g., "database_policy") are matched, the system deduplicates them, returning only the most relevant active version.
4.  **Authority Weighting**: Decisions created by humans (detected via the absence of the `[via MCP]` marker) receive an authority boost (+0.1).

### Status Penalties (Balanced Mode)
- `superseded`: Score × 0.2
- `deprecated`: Score × 0.05
- `draft`: Score × 0.4

---

## Error Codes & Status
- **Permission Denied**: Returned when a tool is called with insufficient RBAC role or missing `AGENT_MEMORY_SECRET`.
- **Isolation Violation**: Returned when an Agent tries to supersede a Human-created decision.
- **Rate Limit Exceeded**: Returned if the cooldown period between write operations is violated.
- **PI1 Violation**: Returned when trying to accept a proposal within its mandatory 1-hour Review Window.
