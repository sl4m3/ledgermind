# Data Schemas

All data models in LedgerMind use Pydantic 2.12+ with strict validation.

---

## Core Event Models

### MemoryEvent

Base type for all information flowing into `process_event()`.

```python
class MemoryEvent(BaseModel):
    schema_version: int = 1
    source: Literal["user", "agent", "system", "reflection_engine", "bridge"]
    kind: Literal["decision", "error", "proposal", "intervention", "commit_change", "task", "call", "prompt", "result"]
    content: str
    context: Union[DecisionContent, ProposalContent, DecisionStream, Dict[str, Any]]
    timestamp: datetime
```

---

## Knowledge Content Models

### DecisionStream

The central model for all evolving behavioral patterns and decisions. A single stream maintains its identity (`decision_id`) as it transitions through different phases.

```python
class DecisionPhase(str, Enum):
    PATTERN = "pattern"
    EMERGENT = "emergent"
    CANONICAL = "canonical"

class DecisionVitality(str, Enum):
    ACTIVE = "active"
    DECAYING = "decaying"
    DORMANT = "dormant"

class PatternScope(str, Enum):
    LOCAL = "local"
    SYSTEM = "system"
    INFRA = "infra"

class DecisionStream(BaseModel):
    decision_id: str
    target: str
    title: str
    rationale: str
    namespace: str = "default"
    scope: PatternScope = PatternScope.LOCAL
    
    phase: DecisionPhase = DecisionPhase.PATTERN
    vitality: DecisionVitality = DecisionVitality.ACTIVE
    provenance: Literal["internal", "external"] = "internal"
    
    # Context & Links
    keywords: List[str] = []
    evidence_event_ids: List[int] = []
    consequences: List[str] = []
    supersedes: List[str] = []
    superseded_by: Optional[str] = None
    
    # Lifecycle Metrics
    frequency: int = 0
    unique_contexts: int = 0
    confidence: float = 0.0
    stability_score: float = 0.0
    
    first_seen: datetime
    last_seen: datetime
    lifetime_days: float = 0.0
    reinforcement_density: float = 0.0
    coverage: float = 0.0
    
    estimated_removal_cost: float = 0.0
    estimated_utility: float = 0.0
```

### Legacy Models (Supported for migration)

### DecisionContent

Payload for `decision`, `constraint`, and `assumption` events.

```python
class DecisionContent(BaseModel):
    title: str
    target: str
    status: Literal["active", "deprecated", "superseded"] = "active"
    rationale: str
    namespace: str = "default"
    evidence_event_ids: List[int] = []
    consequences: List[str] = []
    supersedes: List[str] = []
    superseded_by: Optional[str] = None
```

---

### ProposalContent

Payload for `proposal` events generated by the reflection engine.

```python
class ProposalContent(BaseModel):
    title: str
    target: str
    status: ProposalStatus = "draft"
    rationale: str
    namespace: str = "default"
    confidence: float
    evidence_event_ids: List[int] = []
    suggested_supersedes: List[str] = []
    procedural: Optional[ProceduralContent] = None
    ready_for_review: bool = False
```

---

### ProceduralContent

Used by MemP (Memory-to-Procedure) distillation.

```python
class ProceduralStep(BaseModel):
    action: str
    rationale: Optional[str] = None
    expected_outcome: Optional[str] = None

class ProceduralContent(BaseModel):
    steps: List[ProceduralStep]
    target_task: str
    success_evidence_ids: List[int]
```

---

## Operation Result Models

### MemoryDecision

Returned by write operations.

```python
class MemoryDecision(BaseModel):
    should_persist: bool
    store_type: Literal["episodic", "semantic", "none"]
    reason: str
    metadata: Dict[str, Any] # Contains 'file_id' or 'event_id'
```

---

## Configuration Model

### LedgermindConfig

```python
class LedgermindConfig(BaseModel):
    storage_path: str = "ledgermind"
    ttl_days: int = 30
    trust_boundary: TrustBoundary = "agent"
    namespace: str = "default"
    vector_model: str = "../.ledgermind/models/v5-small-text-matching-Q4_K_M.gguf"
    vector_workers: int = 0
    relevance_threshold: float = 0.7
```

---

## MCP Request Models

### RecordDecisionRequest

```python
class RecordDecisionRequest(BaseModel):
    title: str
    target: str
    rationale: str
    namespace: str = "default"
    consequences: List[str] = []
```

### SupersedeDecisionRequest

```python
class SupersedeDecisionRequest(BaseModel):
    title: str
    target: str
    rationale: str
    old_decision_ids: List[str]
    namespace: str = "default"
    consequences: List[str] = []
```
